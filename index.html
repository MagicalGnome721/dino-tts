<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini TTS (Secure App)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .progress-bar { transition: width 0.5s ease; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl border-t-4 border-green-500">
        <h1 class="text-2xl font-bold text-gray-800 mb-2 text-center uppercase tracking-wide">
            <i class="fas fa-shield-alt text-green-500"></i> Gemini TTS (Secure)
        </h1>
        <p class="text-center text-gray-500 mb-6 text-xs">Phi√™n b·∫£n an to√†n - Kh√¥ng l·ªô API Key</p>

        <div class="mb-4 bg-gray-100 p-3 rounded border border-gray-300 flex justify-between items-center">
            <span class="text-xs font-bold text-gray-500 uppercase">Server Status:</span>
            <span id="server-status" class="text-sm font-mono text-green-600 font-bold">‚úÖ ƒê√£ k·∫øt n·ªëi Cloudflare</span>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">VƒÇN B·∫¢N (K·ªäCH B·∫¢N):</label>
                <textarea id="text-input" rows="5" class="w-full p-3 bg-gray-50 border border-gray-300 rounded focus:border-green-500 outline-none text-sm font-mono text-gray-800" placeholder="Nh·∫≠p k·ªãch b·∫£n v√†o ƒë√¢y..."></textarea>
                <p id="char-count" class="text-xs text-right text-gray-400 mt-1">0 k√Ω t·ª±</p>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">GI·ªåNG ƒê·ªåC:</label>
                    <select id="voice-select" class="w-full p-2 border rounded bg-white font-semibold text-gray-700">
                        <option value="Kore" selected>Kore (N·ªØ - √äm d·ªãu)</option>
                        <option value="Charon">Charon (Nam - Tr·∫ßm)</option>
                        <option value="Fenrir">Fenrir (Nam - M·∫°nh)</option>
                        <option value="Puck">Puck (Nam - Vui)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">PHONG C√ÅCH:</label>
                    <select id="style-select" class="w-full p-2 border rounded bg-green-50 font-bold text-green-800 border-green-200">
                        <option value="discovery" selected>ü¶ñ Discovery (Phim t√†i li·ªáu)</option>
                        <option value="story">üìñ K·ªÉ chuy·ªán (C·∫£m x√∫c)</option>
                        <option value="warmode">‚öîÔ∏è War Mode (H√πng h·ªìn)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">T·ªêC ƒê·ªò:</label>
                    <select id="ai-speed" class="w-full p-2 border rounded bg-gray-50 font-semibold text-gray-700">
                        <option value="slow">üê¢ Ch·∫≠m</option>
                        <option value="normal" selected>üö∂ B√¨nh th∆∞·ªùng</option>
                        <option value="fast">üèÉ Nhanh</option>
                    </select>
                </div>
            </div>

            <div id="progress-area" class="hidden">
                <div class="flex justify-between text-xs font-bold text-gray-600 mb-1">
                    <span id="progress-text">ƒêang k·∫øt n·ªëi Server...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="bg-green-500 h-3 rounded-full progress-bar" style="width: 0%"></div>
                </div>
                <div id="log-box" class="mt-2 text-xs text-green-600 font-mono h-32 overflow-y-auto border p-2 rounded bg-black"></div>
            </div>

            <button id="generate-button" class="w-full bg-gray-800 hover:bg-black text-white font-bold py-3 px-6 rounded-lg transition shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-play"></i> B·∫ÆT ƒê·∫¶U
            </button>
        </div>

        <div id="result-area" class="hidden mt-6 bg-green-50 p-4 rounded border border-green-200 text-center">
            <h3 class="text-green-800 font-bold mb-2">‚úÖ Ho√†n t·∫•t!</h3>
            <audio id="audio-player" controls class="w-full mb-3"></audio>
            <a id="download-link" href="#" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow transition">
                <i class="fas fa-download"></i> T·∫£i file .WAV
            </a>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH B·∫¢O M·∫¨T ---
        // ƒê√¢y l√† link Worker c·ªßa b·∫°n (ƒë√£ l·∫•y t·ª´ h√¨nh ·∫£nh b·∫°n g·ª≠i)
        const WORKER_URL = "https://long-block-6479.khuonglun69.workers.dev"; 

        // --- H√ÄM X·ª¨ L√ù FILE AUDIO ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcmData.length * (bitsPerSample / 8);
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            const writeString = (view, offset, str) => {
                for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
            };

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }
            return new Blob([buffer], { type: 'audio/wav' });
        }

        // --- LOGIC GIAO DI·ªÜN ---
        const els = {
            text: document.getElementById('text-input'),
            voice: document.getElementById('voice-select'),
            style: document.getElementById('style-select'),
            aiSpeed: document.getElementById('ai-speed'), 
            btn: document.getElementById('generate-button'),
            progressArea: document.getElementById('progress-area'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            logBox: document.getElementById('log-box'),
            resultArea: document.getElementById('result-area'),
            audio: document.getElementById('audio-player'),
            download: document.getElementById('download-link'),
            charCount: document.getElementById('char-count')
        };

        els.text.addEventListener('input', () => els.charCount.innerText = `${els.text.value.length} k√Ω t·ª±`);

        function log(msg, type='info') {
            const color = type === 'error' ? 'text-red-500' : 'text-green-400';
            els.logBox.innerHTML += `<div class="${color}">> ${msg}</div>`;
            els.logBox.scrollTop = els.logBox.scrollHeight;
        }

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function splitText(text, maxLength = 1800) { // ƒê√£ t·ªëi ∆∞u cho Worker
            const sentences = text.match(/[^.?!]+[.?!]+|[^.?!]+$/g) || [text];
            const chunks = [];
            let currentChunk = "";
            sentences.forEach(sentence => {
                if ((currentChunk + sentence).length > maxLength) {
                    chunks.push(currentChunk.trim());
                    currentChunk = sentence;
                } else {
                    currentChunk += " " + sentence;
                }
            });
            if (currentChunk) chunks.push(currentChunk.trim());
            return chunks;
        }

        function getSystemInstruction(style, speed) {
            let tone = "";
            let extra = "";

            if (style === "discovery") {
                tone = "You are narrating a long Discovery Channel nature documentary.";
                extra = "CRITICAL: Maintain a perfectly CONSISTENT, steady, and calm tone. Do NOT change pitch or volume. Read smoothly as part of a larger script.";
            } else if (style === "story") {
                tone = "Narrate in a warm, engaging storytelling style.";
                extra = "Focus on emotion and flow.";
            } else if (style === "warmode") {
                tone = "Narrate in a 1940s WWII documentary style. Grave, deep, masculine tone.";
            }

            let speedInstruction = "";
            switch (speed) {
                case "slow": speedInstruction = "Read slowly."; break;
                case "normal": speedInstruction = "Read at a moderate pace."; break;
                case "fast": speedInstruction = "Read at a slightly faster, energetic pace."; break;
            }

            return `(Instruction: ${tone} ${speedInstruction} ${extra} Do NOT read this instruction aloud, just read the text below)`;
        }

        // --- H√ÄM G·ªåI WORKER (B·∫¢O M·∫¨T) ---
        async function fetchAudioFromWorker(chunkText, voice, style, speed) {
            const sysInstruction = getSystemInstruction(style, speed);
            const fullPrompt = `${sysInstruction}\n\n${chunkText}`;

            try {
                // G·ªçi ƒë·∫øn Cloudflare Worker c·ªßa b·∫°n
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server Error: ${response.status}`);
                }

                const result = await response.json();
                
                // Ki·ªÉm tra l·ªói t·ª´ ph√≠a Worker tr·∫£ v·ªÅ (n·∫øu c√≥)
                if (result.error) throw new Error("Worker Error: " + result.error);

                const part = result?.candidates?.[0]?.content?.parts?.[0];
                if (!part?.inlineData?.data) throw new Error("No Audio Data");
                
                const mimeType = part.inlineData.mimeType;
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;

                return { 
                    data: base64ToArrayBuffer(part.inlineData.data),
                    rate: sampleRate
                };

            } catch (e) {
                console.error(e);
                throw e;
            }
        }

        els.btn.addEventListener('click', async () => {
            const fullText = els.text.value.trim();
            if (!fullText) { alert("Ch∆∞a nh·∫≠p text!"); return; }

            els.btn.disabled = true;
            els.resultArea.classList.add('hidden');
            els.progressArea.classList.remove('hidden');
            els.logBox.innerHTML = "";
            
            // C·∫Øt ƒëo·∫°n 1800 k√Ω t·ª± (an to√†n cho Worker)
            const chunks = splitText(fullText, 1800);
            const selectedStyle = els.style.value;
            const selectedSpeed = els.aiSpeed.value;
            
            log(`üîí K·∫øt n·ªëi: Secure Worker`);
            log(`‚úÇÔ∏è S·ªë ƒëo·∫°n: ${chunks.length}`);

            const pcmChunks = [];
            let finalRate = 24000;

            try {
                for (let i = 0; i < chunks.length; i++) {
                    const percent = Math.round(((i) / chunks.length) * 100);
                    els.progressBar.style.width = `${percent}%`;
                    els.progressText.innerText = `ƒêang t·∫£i ƒëo·∫°n ${i+1}/${chunks.length}...`;

                    // G·ªçi Worker
                    const result = await fetchAudioFromWorker(chunks[i], els.voice.value, selectedStyle, selectedSpeed);
                    
                    pcmChunks.push(result.data);
                    finalRate = result.rate;
                    
                    log(`‚úÖ ƒêo·∫°n ${i+1} OK.`);

                    if (i < chunks.length - 1) {
                        await wait(2500); // Ngh·ªâ 2.5s ƒë·ªÉ Worker kh√¥ng b·ªã qu√° t·∫£i
                    }
                }

                log("üîÑ ƒêang gh√©p file...");
                els.progressBar.style.width = `100%`;
                
                let totalLength = 0;
                pcmChunks.forEach(chunk => totalLength += chunk.byteLength);
                
                const mergedPcm = new Int16Array(totalLength / 2);
                let offset = 0;
                
                pcmChunks.forEach(chunk => {
                    const pcm16 = new Int16Array(chunk);
                    mergedPcm.set(pcm16, offset);
                    offset += pcm16.length;
                });

                const finalBlob = pcmToWav(mergedPcm, finalRate);
                const url = URL.createObjectURL(finalBlob);

                els.audio.src = url;
                els.download.href = url;
                els.download.download = `SecureTTS_${Date.now()}.wav`;
                
                els.resultArea.classList.remove('hidden');
                els.progressArea.classList.add('hidden');
                els.audio.play();
                log("üéâ XONG!");

            } catch (e) {
                alert("L·ªói: " + e.message);
                log("‚ùå D·ª™NG L·∫†I.", 'error');
            } finally {
                els.btn.disabled = false;
            }
        });
    </script>
</body>
</html>